---
import Layout from "../layouts/Layout.astro";
export const prerender = false;

// Fetch points from your own server API (keeps NocoDB token off the client)
const res = await fetch(new URL("/api/locations.json", Astro.url));
if (!res.ok) {
  throw new Error(`Failed to load points: ${res.status}`);
}
const { points } = await res.json();

// Turn points into the format the existing Leaflet script expects
const data = (points ?? [])
  .map((p) => ({
    lat: Number(p.latitude),
    lon: Number(p.longitude),
    title: "",
  }))
  .filter((p) => Number.isFinite(p.lat) && Number.isFinite(p.lon));
---

<Layout title="Map">
  <!-- Leaflet assets (use your existing local copies) -->
  <link rel="stylesheet" href="/leaflet/leaflet.css" />
  <script is:inline src="/leaflet/leaflet.js"></script>
  <link rel="stylesheet" href="/leaflet/MarkerCluster.css" />
  <link rel="stylesheet" href="/leaflet/MarkerCluster.Default.css" />
  <script is:inline src="/leaflet/leaflet.markercluster.js"></script>

  <div id="map" style="height: 540px;"></div>
  <pre id="data" style="display:none">{JSON.stringify(data)}</pre>

  <script defer>
    var map = L.map("map").setView([37.4, -119.5], 6);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      minZoom: 4,
      maxZoom: 14,
      attribution:
        '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    var markers = L.markerClusterGroup();

    const data = JSON.parse(document.querySelector("#data").innerText);
    data.forEach((p) => {
      var marker = L.marker(new L.LatLng(p.lat, p.lon));
      markers.addLayer(marker);
    });

    map.addLayer(markers);

    // Optional: auto-fit bounds if you have at least one point
    if (data.length > 0) {
      var bounds = markers.getBounds();
      if (bounds && bounds.isValid && bounds.isValid()) {
        map.fitBounds(bounds, { padding: [20, 20] });
      }
    }
  </script>
</Layout>
